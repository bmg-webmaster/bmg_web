<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Editor de cuadro de bienvenida BMG</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- SweetAlert2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet" />

    <style>
        body {
            padding: 2rem;
            background: #f8f9fa;
        }

        .form-section {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 0 8px rgb(0 0 0 / 0.1);
        }
    </style>
</head>

<body>

    <div class="container">
        <h1 class="mb-4">Editor de cuadro de bienvenida BMG</h1>

        <form id="modalForm" class="form-section">
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="modalHabilitado" />
                <label class="form-check-label" for="modalHabilitado">Modal habilitado</label>
            </div>

            <hr />
            <h5>Title</h5>
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="titleHabilitado" />
                <label class="form-check-label" for="titleHabilitado">Title habilitado</label>
            </div>
            <div class="mb-3">
                <input type="text" class="form-control" id="titleValor" placeholder="Texto del título" />
            </div>

            <hr />
            <h5>Text</h5>
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="textHabilitado" />
                <label class="form-check-label" for="textHabilitado">Text habilitado</label>
            </div>
            <div class="mb-3">
                <input type="text" class="form-control" id="textValor" placeholder="Texto del texto" />
            </div>

            <hr />
            <h5>Imagen</h5>
            <div class="mb-3">
                <label for="imageUrl" class="form-label">URL Imagen</label>
                <input type="text" class="form-control" id="imageUrl" placeholder="URL de la imagen" />
            </div>
            <div class="row">
                <div class="col-6 mb-3">
                    <label for="imageWidth" class="form-label">Ancho imagen (px)</label>
                    <input type="number" class="form-control" id="imageWidth" min="0" />
                </div>
                <div class="col-6 mb-3">
                    <label for="imageHeight" class="form-label">Alto imagen (px)</label>
                    <input type="number" class="form-control" id="imageHeight" min="0" />
                </div>
            </div>
            <div class="mb-3">
                <label for="imageAlt" class="form-label">Alt imagen</label>
                <input type="text" class="form-control" id="imageAlt" placeholder="Texto alternativo de la imagen" />
            </div>

            <hr />
            <div class="mb-3">
                <label for="confirmButtonText" class="form-label">Texto botón confirmar</label>
                <input type="text" class="form-control" id="confirmButtonText"
                    placeholder="Texto del botón continuar" />
            </div>

            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </form>

        <div id="status" class="mt-3"></div>
    </div>

    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const owner = "bmg-webmaster";
        const repo = "bmg_web";
        const path = "configuracion.json";
        const branch = "main";

        let token = "";
        let sha = null;

        const status = document.getElementById("status");
        const form = document.getElementById("modalForm");

        async function pedirToken() {
            const { value: inputToken } = await Swal.fire({
                title: 'Introduce la clave',
                input: 'password',
                inputLabel: 'Clave de acceso',
                inputPlaceholder: 'Escribe tu clave',
                inputAttributes: {
                    autocapitalize: 'off',
                    autocorrect: 'off'
                },
                allowOutsideClick: false,
                allowEscapeKey: false,
                confirmButtonText: 'Continuar',
                showLoaderOnConfirm: true,
                preConfirm: (value) => {
                    if (!value) {
                        Swal.showValidationMessage('La clave es obligatoria');
                        return false;
                    }
                    return value;
                }
            });
            if (inputToken) {
                token = inputToken;
                cargarArchivo();
            }
        }

        async function cargarArchivo() {
            status.textContent = "Cargando archivo...";
            try {
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
                    headers: { Authorization: `token ${token}` }
                });
                if (!response.ok) throw new Error(`HTTP ${response.status} - ${response.statusText}`);

                const data = await response.json();
                sha = data.sha;
                const contenido = atob(data.content);
                const json = JSON.parse(contenido);

                // Rellenar formulario con datos JSON
                document.getElementById("modalHabilitado").checked = json.modalBienvenida.habilitado;

                document.getElementById("titleHabilitado").checked = json.modalBienvenida.title.habilitado;
                document.getElementById("titleValor").value = json.modalBienvenida.title.valor;

                document.getElementById("textHabilitado").checked = json.modalBienvenida.text.habilitado;
                document.getElementById("textValor").value = json.modalBienvenida.text.valor;

                document.getElementById("imageUrl").value = json.modalBienvenida.imageUrl;
                document.getElementById("imageWidth").value = json.modalBienvenida.imageWidth;
                document.getElementById("imageHeight").value = json.modalBienvenida.imageHeight;
                document.getElementById("imageAlt").value = json.modalBienvenida.imageAlt;

                document.getElementById("confirmButtonText").value = json.modalBienvenida.confirmButtonText;

                status.textContent = "Archivo cargado correctamente.";
            } catch (error) {
                status.textContent = "Error al cargar archivo: " + error.message;
                Swal.fire('Error', 'No se pudo cargar el archivo. Revisa tu token o configuración.', 'error').then(() => {
                    pedirToken();
                });
            }
        }

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            status.textContent = "Guardando cambios...";
            try {
                const nuevoJSON = {
                    modalBienvenida: {
                        habilitado: document.getElementById("modalHabilitado").checked,
                        title: {
                            habilitado: document.getElementById("titleHabilitado").checked,
                            valor: document.getElementById("titleValor").value
                        },
                        text: {
                            habilitado: document.getElementById("textHabilitado").checked,
                            valor: document.getElementById("textValor").value
                        },
                        imageUrl: document.getElementById("imageUrl").value,
                        imageWidth: Number(document.getElementById("imageWidth").value),
                        imageHeight: Number(document.getElementById("imageHeight").value),
                        imageAlt: document.getElementById("imageAlt").value,
                        confirmButtonText: document.getElementById("confirmButtonText").value
                    }
                };

                const contenidoBase64 = btoa(unescape(encodeURIComponent(JSON.stringify(nuevoJSON, null, 2))));

                const body = {
                    message: "Actualizar configuracion modal desde editor web",
                    content: contenidoBase64,
                    branch,
                    sha
                };

                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                    method: "PUT",
                    headers: {
                        Authorization: `token ${token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(body)
                });

                if (!response.ok) throw new Error(`HTTP ${response.status} - ${response.statusText}`);

                const data = await response.json();
                sha = data.content.sha;

                status.textContent = "Cambios guardados correctamente.";
                Swal.fire('¡Listo!', 'Archivo guardado.', 'success');
            } catch (error) {
                status.textContent = "Error al guardar: " + error.message;
                Swal.fire('Error', 'No se pudieron guardar los cambios. Revisa conexión.', 'error');
            }
        });

        // Inicio:
        pedirToken();
    </script>

</body>

</html>